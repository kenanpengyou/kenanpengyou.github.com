---
layout: post
title: "3d transform的坐标空间及位置"
category: "css"
description: ""
---
{% include JB/setup %}

##css里的3d理念##

使用css3的3d transform，就可以在平面的网页里添加炫酷的三维视觉效果，这很令人愉悦。

需要注意的是，3d transform只是css的一部分，它并不是一个三维引擎（3d engine）。三维引擎一般是这样的（游戏引擎Unity3D）：

![Unity3D][img_unity3d_impression]

包括JavaScript 3D库[three.js][]在内，简单来说，它们这些可以称为三维引擎的，都会包括：

- 独立的三维坐标系统。
- 几何图形和材质贴图。
- 光照和摄像机。

显然，3d transform相比起来，是缺少这些内容的。毕竟，css的关注点是网页样式，而不是创建虚拟空间。

尽管3d transform的三维空间能力有所不足，但它仍然可以创建出很棒的三维效果。这就需要我们开发者来用心了。

##3d transform的坐标系统##

我们很熟悉的网页是平面的，一个DOM元素，比如一个`<div>`，它会有一个**初始坐标系**（**initial coordinate system**）：

![初始坐标系][img_initial_coordinate_system]

每一个DOM元素都有一个这样的初始坐标系。其中，原点位于元素的左上角，z轴指向观察者（也就是屏幕外的我们）。初始坐标系的z轴并不算是三维空间，而是像`z-index`那样作为参照，决定网页元素的绘制顺序，绘制顺序靠后的元素将覆盖绘制顺序靠前的。

在使用transform的时候，情况则有所不同。transform所参照的并不是初始坐标系，而是一个新的坐标系：

![变换坐标系][img_transform_coordinate_system]

transform所用的这个坐标系，相比初始坐标系，x、y、z轴的指向都不变，只是原点位置移动到了元素的正中心。如果想要改变这个坐标系的原点位置，使用`transform-origin`。`transform-origin`的默认值是`50% 50%`，因此，默认情况下，transform坐标系的原点位于元素中心。

##transform的顺序##

我们都可能像`transform: rotateY(45deg) translateX(100px);`这样使用多个变换函数。这种时候，需要意识到变换函数的顺序。这是因为，**每一个变换函数不仅改变了元素，同时也会改变和元素关联的transform坐标系**，当变换函数依次执行时，后一个变换函数总是基于前一个变换后的新transform坐标系。

例如，下面一个包含两个变换函数的transform的效果（gif）：

![transform顺序1][img_transform_order_1]

如果交换这两个变换函数的顺序，是这样的效果：

![transform顺序2][img_transform_order_2]

可以看到，由于坐标系会随着每一次变换发生改变，因此不同顺序的情况下，元素最终的位置也不同。

对此还有一种解释，即变换函数是通过数学上的矩阵乘法运算完成的，而矩阵的乘法是不满足交换律的。任意坐标空间内的变换函数或者变换函数的组合，都可以转换为一个矩阵（还有一个[矩阵小工具][]可以帮你做这个转换）。

##创建三维物体##

前面已经提到，3d transform并没有像三维引擎那样为你创建三维场景提供全面的资源。因此，就以创建一个三维物体来说，我们只能利用网页目前已有的内容，自己想办法。

在网页里，你并不能直接定义一系列坐标为`(x, y, z)`的空间中的点，然后基于这些点来生成三维图形。网页里有的，是平面图形。不管是`<div>`还是其他html元素，它们都是平的，没有厚度，像纸片一样。但纸片就可以搭东西，所以，一个DOM元素用作三维物体的一个“面”，把这些“面”有序地组织起来，得到的就是三维物体了！

事实上，在三维引擎里，三维物体也不是实体，它们都是由一系列平面（多边形）所围成的（并可以在平面上添加纹理和贴图）。

###正方体###

现在来做一个正方体，现在先不用考虑perspective。正方体有六个面，然后需要用一个元素来装这六个面，所以html是：

{% highlight html %}
<div class="cube">
    <div class="surface surface-1">1</div>
    <div class="surface surface-2">2</div>
    <div class="surface surface-3">3</div>
    <div class="surface surface-4">4</div>
    <div class="surface surface-5">5</div>
    <div class="surface surface-6">6</div>
</div>
{% endhighlight %}

对应的css是（边长120px）：

{% highlight css %}
.cube{
    position: absolute;
    transform-style: preserve-3d;
}
.cube .surface{
    position: absolute;
    width: 120px;
    height: 120px;
    border: 1px solid #ccc;
    background: rgba(255,255,255,0.8);
    box-shadow: inset 0 0 20px rgba(0,0,0,0.2);
    line-height: 120px;
    text-align: center;
    color: #333;
    font-size: 100px;
}
.cube .surface-1 {
    transform: translateZ(60px);
}
.cube .surface-2 {
    transform: rotateY(90deg) translateZ(60px);
} 
.cube .surface-3 {
    transform: rotateX(90deg) translateZ(60px);
}
.cube .surface-4 {
    transform: rotateY(180deg) translateZ(60px);
}
.cube .surface-5 {
    transform: rotateY(-90deg) translateZ(60px);
}
.cube .surface-6 {
    transform: rotateX(-90deg) translateZ(60px);
}
{% endhighlight %}

其中，`transform-style: preserve-3d;`保证所有子元素都处于同一个三维空间（这里是三维渲染上下文[3D rendering context][]）内，也就是告诉浏览器你是想用这些元素做一个三维场景，而不仅仅只是要单个元素的简单三维效果。

`position: absolute;`是一个习惯做法，因为三维物体并不符合一般平面网页内容的排版，所以我们会比较多地希望它不要占据布局空间。

6个面位置都不一样，但却都有`translateZ(60px);`，你已经知道这是因为巧妙搭配了在它之前的变换函数。

一旦构成正方体的6个`div.surface`的位置确定后，就可以操作它们的父元素`div.cube`来整体移动、旋转这个正方体。

##将三维物体添加到可视区域##

只是有了这样的一个三维物体，我们就可以说有了一个三维场景了。但是，三维场景和平面图不同，比如这个正方体，我从不同的位置，不同的角度去观察它，我眼里看到的都是不一样的。那么，这样的三维场景要如何呈现在平面的网页里呢？

这就是三维引擎里的摄像机的概念了。就像电影里表现同一个场景会用不同的镜头那样，我们需要定义场景里的摄像机来生成最终呈现在屏幕里的二维画面。这其中，指定摄像机的位置，拍摄角度就是很重要的内容了。比如three.js里的摄像机



##transform对布局的影响##




##结语##

想要让元素稳定地待在为它预定的位置上，还是有很多功课要做的。本文只介绍了一部分有关位置的细节知识，如果你也曾对这些内容有所困惑，那么希望能有所帮助。

[img_unity3d_impression]: {{POSTS_IMG_PATH}}/201512/unity3d_impression.png "Unity3D"
[img_initial_coordinate_system]: {{POSTS_IMG_PATH}}/201512/initial_coordinate_system.png "初始坐标系"
[img_transform_coordinate_system]: {{POSTS_IMG_PATH}}/201512/transform_coordinate_system.png "变换坐标系"
[img_transform_order_1]: {{POSTS_IMG_PATH}}/201512/transform_order_1.gif "transform顺序1"
[img_transform_order_2]: {{POSTS_IMG_PATH}}/201512/transform_order_2.gif "transform顺序2"

[three.js]: http://threejs.org/ "three.js - Javascript 3D library"
[矩阵小工具]: http://meyerweb.com/eric/tools/matrix/ "The Matrix Resolutions"
[3D rendering context]: http://www.w3.org/TR/css-transforms-1/#3d-transform-rendering "CSS Transforms Module Level 1"
